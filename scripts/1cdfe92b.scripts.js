"use strict";angular.module("pollingAppApp",["ngCookies","firebase","ngResource","ngSanitize","ngRoute"]).config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/main.html",controller:"MainCtrl"}).when("/new",{templateUrl:"views/new.html",controller:"NewCtrl"}).when("/poll/:id",{templateUrl:"views/poll.html",controller:"PollCtr"}).when("/results/:id",{templateUrl:"views/results.html",controller:"ResultsCtrl"}).otherwise({redirectTo:"/"})}]).constant("FBURL","https://af-pollingapp.firebaseio.com/").constant("POLLSURL","https://af-pollingapp.firebaseio.com/polls"),angular.module("pollingAppApp").controller("MainCtrl",["$scope","$rootScope","$location","PollsService",function(a,b,c,d){var e=d.getPolls();a.errors=[],e.then(function(c){a.polls=c,b.randomPoll=c[Math.floor(Math.random()*c.length)].$id},function(a){console.error(a)}),a.addPoll=function(){c.url("/new")},a.openPoll=function(a){c.url("/poll/"+a)}}]),angular.module("pollingAppApp").controller("NewCtrl",["$scope","$location","PollsService","$filter",function(a,b,c,d){a.poll={question:"",options:[{votes:0,name:""},{votes:0,name:""}]},a.newOptions=[],a.validateOptions=function(a){for(var b=0;b<a.length;b++)if(!a[b].name)return!1;return!0},a.create=function(){if(a.poll.question&&a.validateOptions(a.poll.options)&&a.validateOptions(a.newOptions)){a.poll.options=a.poll.options.concat(a.newOptions);var e=new Date;a.poll.timestamp=d("date")(e,"MM/dd/yyyy @ h:mma","EDT"),a.poll.totalVotes=0,c.addPoll(a.poll),b.url("/")}},a.addOption=function(){a.newOptions.push({votes:0,name:""})},a.removeOption=function(b){a.newOptions.splice(b,1)}}]),angular.module("pollingAppApp").controller("PollCtr",["$scope","$rootScope","$location","PollsService","$routeParams",function(a,b,c,d,e){a.id=e.id;var f=d.getIP();f.then(function(b){a.ip=b,a.ip=a.ip.replace(/\./g," ")},function(a){console.error(a)});var g=d.getPoll(a.id);g.then(function(b){a.poll=b},function(a){console.error(a)}),a.selectedOption="",a.vote=function(){if(a.selectedOption){if(a.poll[a.ip])b.alreadyVotedMsg="A vote from this IP address has already been submitted. ";else{var e=a.poll.options[a.selectedOption].votes+1,f=a.poll.totalVotes+1;d.updateTotalVotes(a.id,f),d.updateVote(a.id,parseInt(a.selectedOption),e),d.setIp(a.id,a.ip),b.alreadyVotedMsg=null}c.url(/results/+a.id)}};var h=d.getRandomPoll();h.then(function(a){b.randomPoll=a},function(a){console.error(a)})}]),angular.module("pollingAppApp").controller("ResultsCtrl",["$scope","$rootScope","$location","PollsService","$routeParams",function(a,b,c,d,e){var f=e.id,g=d.getPoll(f);g.then(function(b){a.poll=b},function(a){console.error(a)});var h=d.getRandomPoll();h.then(function(a){b.randomPoll=a},function(a){console.error(a)})}]),angular.module("pollingAppApp").controller("NavCtrl",["$scope","PollsService",function(a,b){var c=b.getRandomPoll();c.then(function(b){a.randomPoll=b},function(a){console.error(a)})}]),function(a){a.module("pollingAppApp").service("PollsService",["POLLSURL","$q","$firebaseArray","$http",function(a,b,c,d){var e=new Firebase(a),f=c(e);return{addPoll:function(a){return f.$add(a)},getIP:function(){var a=b.defer();return d.get("http://ipinfo.io/json").success(function(b){a.resolve(b.ip)}),a.promise},getPolls:function(){return f.$loaded(function(a){return a})},getPoll:function(a){return f.$loaded(function(b){return b.$getRecord(a)})},getRandomPoll:function(){return f.$loaded(function(a){var b=a[Math.floor(Math.random()*a.length)].$id;return b})},updateVote:function(a,b,c){return f.$ref().child(a).child("options").child(b).update({votes:c})},setIp:function(a,b){var c={};return c[b]=!0,f.$ref().child(a).update(c)},updateTotalVotes:function(a,b){return f.$ref().child(a).update({totalVotes:b})}}}])}(window.angular);